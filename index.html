<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Antigravity PDF</title>
    
    <!-- PWA Setup -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/337/337946.png">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; padding-bottom: env(safe-area-inset-bottom); overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .sheet-hidden { transform: translateY(100%); }
        .sheet-visible { transform: translateY(0); }
        .backdrop-hidden { opacity: 0; pointer-events: none; }
        .backdrop-visible { opacity: 1; pointer-events: auto; }
        .loader { width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .chip-active { background-color: #ffffff; color: #2563eb; font-weight: 800; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .chip-inactive { background-color: rgba(30, 64, 175, 0.5); color: #bfdbfe; border: 1px solid rgba(191, 219, 254, 0.2); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- Header -->
    <header class="bg-blue-600 text-white pt-[env(safe-area-inset-top)] z-30 shadow-md shrink-0">
        <div class="px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-xl"></i>
                <h1 class="text-lg font-bold tracking-wide">Antigravity</h1>
            </div>
            <button onclick="app.openSheet('settings')" class="w-8 h-8 flex items-center justify-center bg-blue-700 rounded-full active:scale-90 transition-transform"><i class="fa-solid fa-gear text-sm"></i></button>
        </div>

        <div class="px-4 pb-3">
            <div class="relative mb-3">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-blue-200"></i>
                <input type="text" id="search-box" oninput="app.renderList()" 
                    class="w-full bg-blue-700/50 text-white placeholder-blue-200 rounded-xl py-2.5 pl-10 pr-4 border-none focus:ring-2 focus:ring-white/50 text-sm"
                    placeholder="Search files...">
            </div>
            <div class="flex items-center gap-3">
                <button onclick="app.openSheet('sort')" class="bg-blue-800 text-white px-3 py-1.5 rounded-lg flex items-center gap-2 text-xs font-bold shrink-0 shadow-sm active:bg-blue-900 transition-colors">
                    <i class="fa-solid fa-arrow-up-wide-short"></i>
                    <span id="current-sort-label">Sort</span>
                </button>
                <div class="w-px h-6 bg-blue-500/50"></div>
                <div class="flex gap-2 overflow-x-auto no-scrollbar flex-1" id="filter-chips"></div>
            </div>
        </div>
    </header>

    <main id="file-list" class="flex-1 overflow-y-auto p-4 space-y-3 pb-24 bg-slate-100"></main>
    
    <div id="empty-state" class="hidden absolute inset-0 top-32 flex flex-col items-center justify-center pointer-events-none p-6">
        <i class="fa-solid fa-rocket text-6xl text-slate-300 mb-4"></i>
        <h2 class="text-xl font-bold text-slate-400">No Files Found</h2>
        <p class="text-sm text-slate-400 text-center mt-2">Tap + to add documents.</p>
    </div>

    <button onclick="app.openSheet('upload')" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-xl flex items-center justify-center text-2xl z-40 active:scale-90 transition-transform"><i class="fa-solid fa-plus"></i></button>
    <div id="backdrop" onclick="app.closeAllSheets()" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 backdrop-hidden transition-opacity duration-300"></div>

    <!-- Sheets -->
    <div id="sheet-settings" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl z-50 sheet-hidden transition-transform duration-300 pb-[env(safe-area-inset-bottom)]">
        <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mt-3 mb-4"></div>
        <div class="px-6 pb-6 space-y-2">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Settings</h3>
            <button onclick="app.switchSheet('types')" class="w-full flex items-center gap-4 p-4 bg-slate-50 rounded-xl hover:bg-slate-100 transition-colors text-left"><div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fa-solid fa-tags"></i></div><div><h4 class="font-bold text-slate-800">Manage Types</h4><p class="text-xs text-slate-500">Categories</p></div></button>
            <button onclick="app.switchSheet('backup')" class="w-full flex items-center gap-4 p-4 bg-slate-50 rounded-xl hover:bg-slate-100 transition-colors text-left"><div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center"><i class="fa-solid fa-hard-drive"></i></div><div><h4 class="font-bold text-slate-800">Backup & Restore</h4><p class="text-xs text-slate-500">Zip Export/Import</p></div></button>
            <button id="pwa-install-btn" onclick="app.installPWA()" class="w-full flex items-center gap-4 p-4 bg-slate-50 rounded-xl hover:bg-slate-100 transition-colors text-left hidden"><div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center"><i class="fa-solid fa-download"></i></div><div><h4 class="font-bold text-slate-800">Install App</h4><p class="text-xs text-slate-500">Add to Home Screen</p></div></button>
        </div>
    </div>

    <div id="sheet-backup" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl z-50 sheet-hidden transition-transform duration-300 pb-[env(safe-area-inset-bottom)]">
        <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mt-3 mb-4"></div>
        <div class="px-6 pb-6"><h3 class="text-xl font-bold text-slate-800 mb-2">Backup & Restore</h3><div id="backup-progress-container" class="hidden mb-6"><div class="w-full bg-slate-200 rounded-full h-2.5"><div id="backup-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div></div></div><div class="space-y-3"><button onclick="app.exportBackup()" id="btn-export" class="w-full flex items-center gap-3 p-4 bg-green-50 border border-green-200 rounded-xl text-left"><div class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center"><i class="fa-solid fa-download"></i></div><div><h4 class="font-bold text-green-900">Export Zip</h4></div></button><div class="relative w-full"><input type="file" accept=".zip" class="absolute inset-0 w-full h-full opacity-0 z-10" onchange="app.importBackup(this)"><div class="w-full flex items-center gap-3 p-4 bg-blue-50 border border-blue-200 rounded-xl text-left"><div class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center"><i class="fa-solid fa-upload"></i></div><div><h4 class="font-bold text-blue-900">Import Zip</h4></div></div></div></div></div>
    </div>

    <div id="sheet-sort" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl z-50 sheet-hidden transition-transform duration-300 pb-[env(safe-area-inset-bottom)]"><div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mt-3 mb-4"></div><div class="px-6 pb-6"><h3 class="text-xl font-bold text-slate-800 mb-4">Sort By</h3><div class="space-y-2"><button onclick="app.applySort('year_desc')" class="sort-opt w-full text-left px-4 py-3 rounded-xl bg-slate-50 flex justify-between items-center"><span class="font-semibold text-slate-700">Year (Newest)</span><i class="fa-solid fa-check text-blue-600 opacity-0 sort-check" id="check-year_desc"></i></button><button onclick="app.applySort('year_asc')" class="sort-opt w-full text-left px-4 py-3 rounded-xl bg-slate-50 flex justify-between items-center"><span class="font-semibold text-slate-700">Year (Oldest)</span><i class="fa-solid fa-check text-blue-600 opacity-0 sort-check" id="check-year_asc"></i></button><button onclick="app.applySort('no_desc')" class="sort-opt w-full text-left px-4 py-3 rounded-xl bg-slate-50 flex justify-between items-center"><span class="font-semibold text-slate-700">File No (Desc)</span><i class="fa-solid fa-check text-blue-600 opacity-0 sort-check" id="check-no_desc"></i></button><button onclick="app.applySort('date_new')" class="sort-opt w-full text-left px-4 py-3 rounded-xl bg-slate-50 flex justify-between items-center"><span class="font-semibold text-slate-700">Date Added</span><i class="fa-solid fa-check text-blue-600 opacity-0 sort-check" id="check-date_new"></i></button></div></div></div>
    
    <div id="sheet-upload" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl z-50 sheet-hidden transition-transform duration-300 max-h-[90vh] overflow-y-auto pb-[env(safe-area-inset-bottom)]"><div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mt-3 mb-4"></div><div class="px-6 pb-6"><h3 class="text-xl font-bold text-slate-800 mb-6">Upload</h3><form onsubmit="event.preventDefault(); app.processUpload();" class="space-y-5"><div id="drop-zone" class="border-2 border-dashed border-slate-300 rounded-2xl h-32 flex flex-col items-center justify-center bg-slate-50 relative"><input type="file" id="file-input" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 z-10" onchange="app.handleFileSelect(this)"><div id="upload-icon" class="text-slate-400 text-3xl mb-2"><i class="fa-solid fa-cloud-arrow-up"></i></div><p id="upload-text" class="text-sm font-medium text-slate-500">Tap to select PDF</p></div><div class="flex gap-4"><div class="flex-1"><label class="text-xs font-bold text-slate-500 uppercase ml-1">File No</label><input type="text" id="inp-no" required class="w-full bg-slate-100 rounded-xl px-4 py-3 text-sm font-semibold outline-none" placeholder="101"></div><div class="flex-1"><label class="text-xs font-bold text-slate-500 uppercase ml-1">Year</label><input type="tel" id="inp-year" required class="w-full bg-slate-100 rounded-xl px-4 py-3 text-sm font-semibold outline-none" placeholder="2025"></div></div><div><label class="text-xs font-bold text-slate-500 uppercase ml-1">Type</label><select id="inp-type" class="w-full bg-slate-100 rounded-xl px-4 py-3 text-sm font-semibold outline-none appearance-none type-dropdown"></select></div><div><label class="text-xs font-bold text-slate-500 uppercase ml-1">Description</label><textarea id="inp-desc" rows="2" required class="w-full bg-slate-100 rounded-xl px-4 py-3 text-sm font-medium outline-none" placeholder="Details..."></textarea></div><button type="submit" id="btn-upload" class="w-full bg-blue-600 text-white rounded-xl py-4 font-bold text-lg shadow-lg active:scale-95 transition-transform flex justify-center items-center gap-2"><span>Save</span><div id="loader-upload" class="loader hidden"></div></button></form></div></div>

    <div id="sheet-edit" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl z-50 sheet-hidden transition-transform duration-300 pb-[env(safe-area-inset-bottom)]"><div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mt-3 mb-4"></div><div class="px-6 pb-6 space-y-4"><h3 class="text-xl font-bold text-slate-800 mb-4">Edit Details</h3><input type="hidden" id="edit-id"><div class="flex gap-4"><input type="text" id="edit-no" class="flex-1 bg-slate-100 rounded-xl px-4 py-3 text-sm font-semibold"><input type="tel" id="edit-year" class="flex-1 bg-slate-100 rounded-xl px-4 py-3 text-sm font-semibold"></div><select id="edit-type" class="w-full bg-slate-100 rounded-xl px-4 py-3 text-sm font-semibold type-dropdown"></select><textarea id="edit-desc" rows="3" class="w-full bg-slate-100 rounded-xl px-4 py-3 text-sm font-medium"></textarea><div class="flex gap-3 pt-2"><button onclick="app.deleteItem()" class="flex-1 bg-red-100 text-red-600 py-3 rounded-xl font-bold active:scale-95">Delete</button><button onclick="app.saveEdit()" class="flex-[2] bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95">Save</button></div></div></div>

    <div id="sheet-types" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl z-50 sheet-hidden transition-transform duration-300 h-[85vh] flex flex-col pb-[env(safe-area-inset-bottom)]"><div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mt-3 mb-4 shrink-0"></div><div class="px-6 pb-4 shrink-0"><h3 class="text-xl font-bold text-slate-800">Manage Types</h3><form onsubmit="event.preventDefault(); app.addType();" class="flex gap-2 mt-4"><input type="text" id="new-type-name" class="flex-1 bg-slate-100 rounded-xl px-4 py-3 text-sm font-semibold outline-none" placeholder="New Type Name" required><button type="submit" class="bg-blue-600 text-white px-5 rounded-xl font-bold active:scale-95">Add</button></form></div><div class="flex-1 overflow-y-auto px-6 pb-6 space-y-2" id="types-list"></div></div>

    <script>
        // Register Service Worker for PWA capabilities
        if ('serviceWorker' in navigator) {
            // Only register SW if protocol is http or https (prevents errors in blob/file previews)
            if (window.location.protocol.startsWith('http')) {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered!', reg))
                    .catch(err => console.error('SW Failed', err));
            }
        }

        // Install Prompt Logic
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('pwa-install-btn').classList.remove('hidden');
        });

        // App Logic (Same as V5)
        const db={conn:null,async init(){return new Promise(e=>{const t=indexedDB.open("AntigravityDB",1);t.onupgradeneeded=e=>{e.target.result.objectStoreNames.contains("files")||e.target.result.createObjectStore("files")},t.onsuccess=t=>{this.conn=t.target.result,e()}})},async save(e,t){const n=this.conn.transaction(["files"],"readwrite");n.objectStore("files").put(t,e);return new Promise(e=>n.oncomplete=e)},async get(e){return new Promise(t=>{this.conn.transaction(["files"],"readonly").objectStore("files").get(e).onsuccess=e=>t(e.target.result)})},async del(e){const t=this.conn.transaction(["files"],"readwrite");t.objectStore("files").delete(e);return new Promise(e=>t.oncomplete=e)},async clear(){const e=this.conn.transaction(["files"],"readwrite");e.objectStore("files").clear();return new Promise(t=>e.oncomplete=t)},async getAllKeys(){return new Promise(e=>{this.conn.transaction(["files"],"readonly").objectStore("files").getAllKeys().onsuccess=t=>e(t.target.result)})}};
        
        const app = {
            data: [], types: [], tempFile: null, filterType: 'All', sortMode: 'year_desc',
            async init() {
                const storedMeta = localStorage.getItem('AntigravityMeta_v5'); if (storedMeta) this.data = JSON.parse(storedMeta);
                const storedTypes = localStorage.getItem('AntigravityTypes_v5'); this.types = storedTypes ? JSON.parse(storedTypes) : ["Document", "Personal", "Work"]; 
                this.filterType = localStorage.getItem('AntigravityFilter') || 'All'; this.sortMode = localStorage.getItem('AntigravitySort') || 'year_desc';
                await db.init(); this.renderUI();
            },
            installPWA() {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') document.getElementById('pwa-install-btn').classList.add('hidden');
                        deferredPrompt = null;
                    });
                }
            },
            renderUI() { this.renderTypesUI(); this.renderList(); this.updateSortUI(); },
            renderList() {
                const q = document.getElementById('search-box').value.toLowerCase();
                const listEl = document.getElementById('file-list');
                const emptyEl = document.getElementById('empty-state');
                let list = this.data.filter(i => {
                    const matchesSearch = i.no.toLowerCase().includes(q) || i.name.toLowerCase().includes(q) || i.desc.toLowerCase().includes(q) || (i.content && i.content.toLowerCase().includes(q));
                    const matchesType = this.filterType === 'All' || i.type === this.filterType;
                    return matchesSearch && matchesType;
                });
                list.sort((a,b) => {
                    switch(this.sortMode) {
                        case 'year_desc': return (b.year - a.year) || b.no.localeCompare(a.no, undefined, {numeric:true});
                        case 'year_asc': return (a.year - b.year) || a.no.localeCompare(b.no, undefined, {numeric:true});
                        case 'no_asc': return a.no.localeCompare(b.no, undefined, {numeric:true});
                        case 'no_desc': return b.no.localeCompare(a.no, undefined, {numeric:true});
                        case 'date_new': return b.date - a.date;
                        default: return b.year - a.year;
                    }
                });
                listEl.innerHTML = '';
                if(list.length === 0) { emptyEl.classList.remove('hidden'); return; }
                emptyEl.classList.add('hidden');
                list.forEach(item => {
                    const el = document.createElement('div'); el.className = "bg-white p-4 rounded-2xl shadow-sm border border-slate-200/60 active:scale-[0.98] transition-transform"; el.onclick = (e) => { if(!e.target.closest('.action-btn')) this.openFile(item.id); };
                    el.innerHTML = `<div class="flex justify-between items-start mb-2"><div class="flex gap-2"><span class="bg-blue-100 text-blue-700 text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded-md">${item.type}</span><span class="bg-slate-100 text-slate-600 text-[10px] font-bold px-2 py-1 rounded-md">#${item.no}</span></div><button onclick="app.prepEdit('${item.id}')" class="action-btn text-slate-300 hover:text-blue-600 p-2 -mr-2 -mt-2"><i class="fa-solid fa-ellipsis"></i></button></div><div class="flex items-center gap-4"><div class="w-10 h-10 rounded-lg bg-red-50 text-red-500 flex items-center justify-center text-xl shrink-0"><i class="fa-solid fa-file-pdf"></i></div><div class="min-w-0 flex-1"><h4 class="font-bold text-slate-800 text-sm truncate leading-tight">${item.name}</h4><p class="text-xs text-slate-500 mt-0.5 line-clamp-1">${item.desc}</p></div></div><div class="mt-3 pt-3 border-t border-slate-50 flex justify-between items-center text-[10px] text-slate-400 font-medium"><span>${item.year}</span><span>${new Date(item.date).toLocaleDateString()}</span></div>`;
                    listEl.appendChild(el);
                });
            },
            async exportBackup() {
                const btn = document.getElementById('btn-export');
                const bar = document.getElementById('backup-bar');
                document.getElementById('backup-progress-container').classList.remove('hidden');
                try {
                    const zip = new JSZip();
                    zip.file("meta.json", JSON.stringify(this.data));
                    zip.file("types.json", JSON.stringify(this.types));
                    const filesFolder = zip.folder("files");
                    const keys = await db.getAllKeys();
                    for(let i=0; i<keys.length; i++) {
                        const blob = await db.get(keys[i]); if(blob) filesFolder.file(`${keys[i]}.pdf`, blob);
                        bar.style.width = `${Math.round(((i+1)/keys.length)*90)}%`;
                    }
                    const content = await zip.generateAsync({type:"blob"});
                    const a = document.createElement('a'); a.href = URL.createObjectURL(content); a.download = `Antigravity_Backup_${new Date().toISOString().slice(0,10)}.zip`; a.click();
                    bar.style.width = '100%'; setTimeout(() => { document.getElementById('backup-progress-container').classList.add('hidden'); bar.style.width = '0%'; }, 2000);
                } catch(e) { alert(e.message); }
            },
            async importBackup(input) {
                if(!input.files[0] || !confirm("Restore? This overwrites current data.")) return;
                document.getElementById('backup-progress-container').classList.remove('hidden');
                try {
                    const zip = await JSZip.loadAsync(input.files[0]);
                    const newMeta = JSON.parse(await zip.file("meta.json").async("string"));
                    const newTypes = JSON.parse(await zip.file("types.json").async("string"));
                    await db.clear();
                    const promises = [];
                    zip.folder("files").forEach((path, entry) => {
                        promises.push(entry.async("blob").then(blob => db.save(path.replace('.pdf',''), blob)));
                    });
                    await Promise.all(promises);
                    this.data = newMeta; this.types = newTypes; this.saveMeta(); this.saveTypes();
                    alert("Restored!"); location.reload();
                } catch(e) { alert("Failed: " + e.message); }
            },
            applyFilter(t) { this.filterType = t; localStorage.setItem('AntigravityFilter', t); this.renderUI(); },
            applySort(m) { this.sortMode = m; localStorage.setItem('AntigravitySort', m); this.renderUI(); this.closeAllSheets(); },
            updateSortUI() { document.querySelectorAll('.sort-check').forEach(el => el.classList.add('opacity-0')); const check = document.getElementById(`check-${this.sortMode}`); if(check) check.classList.remove('opacity-0'); },
            renderTypesUI() {
                document.getElementById('filter-chips').innerHTML = ['All', ...this.types].map(t => `<button onclick="app.applyFilter('${t}')" class="${this.filterType === t ? 'chip-active' : 'chip-inactive'} px-3 py-1.5 rounded-full text-xs whitespace-nowrap transition-all">${t}</button>`).join('');
                document.querySelectorAll('.type-dropdown').forEach(dd => { const v = dd.value; dd.innerHTML = this.types.map(t => `<option value="${t}">${t}</option>`).join(''); if(this.types.includes(v)) dd.value = v; });
                document.getElementById('types-list').innerHTML = this.types.map(t => `<div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100"><span class="font-bold text-slate-700">${t}</span><button onclick="app.deleteType('${t}')" class="text-red-500 bg-red-50 w-8 h-8 rounded-full flex items-center justify-center"><i class="fa-solid fa-trash text-xs"></i></button></div>`).join('');
            },
            saveTypes() { localStorage.setItem('AntigravityTypes_v5', JSON.stringify(this.types)); this.renderUI(); },
            addType() { const n = document.getElementById('new-type-name').value.trim(); if(n&&!this.types.includes(n)) { this.types.push(n); this.saveTypes(); document.getElementById('new-type-name').value=''; }},
            deleteType(n) { if(confirm(`Delete "${n}"?`)) { this.types = this.types.filter(t=>t!==n); if(this.filterType===n) this.filterType='All'; this.saveTypes(); }},
            async processUpload() {
                if (!this.tempFile) return alert("Select file");
                document.getElementById('btn-upload').disabled = true;
                try {
                    const id = crypto.randomUUID(); const text = await this.extractText(this.tempFile); await db.save(id, this.tempFile);
                    this.data.unshift({id, name: this.tempFile.name, no: document.getElementById('inp-no').value, year: parseInt(document.getElementById('inp-year').value), type: document.getElementById('inp-type').value, desc: document.getElementById('inp-desc').value, content: text, date: Date.now()});
                    this.saveMeta(); this.renderUI(); this.closeAllSheets();
                } catch(e) { alert(e.message); } document.getElementById('btn-upload').disabled = false;
            },
            async extractText(file) { const buff = await file.arrayBuffer(); const pdf = await pdfjsLib.getDocument({data: buff}).promise; let str = ""; for(let i=1; i<=Math.min(pdf.numPages,5); i++) str += (await (await pdf.getPage(i)).getTextContent()).items.map(s=>s.str).join(" "); return str.substring(0,3000); },
            async openFile(id) { try { const blob = await db.get(id); if(blob) window.open(URL.createObjectURL(blob)); } catch(e) {} },
            prepEdit(id) { const i = this.data.find(x => x.id === id); if(!i) return; document.getElementById('edit-id').value = id; document.getElementById('edit-no').value = i.no; document.getElementById('edit-year').value = i.year; document.getElementById('edit-type').value = i.type; document.getElementById('edit-desc').value = i.desc; this.openSheet('edit'); },
            saveEdit() { const id = document.getElementById('edit-id').value; const i = this.data.find(x => x.id === id); if(i) { i.no = document.getElementById('edit-no').value; i.year = parseInt(document.getElementById('edit-year').value); i.type = document.getElementById('edit-type').value; i.desc = document.getElementById('edit-desc').value; this.saveMeta(); this.renderUI(); this.closeAllSheets(); } },
            async deleteItem() { if(confirm("Delete?")) { const id = document.getElementById('edit-id').value; await db.del(id); this.data = this.data.filter(x => x.id !== id); this.saveMeta(); this.renderUI(); this.closeAllSheets(); } },
            openSheet(id) { document.getElementById('backdrop').classList.replace('backdrop-hidden', 'backdrop-visible'); document.getElementById(`sheet-${id}`).classList.replace('sheet-hidden', 'sheet-visible'); },
            switchSheet(id) { document.querySelectorAll('[id^="sheet-"]').forEach(el => el.classList.replace('sheet-visible', 'sheet-hidden')); document.getElementById(`sheet-${id}`).classList.replace('sheet-hidden', 'sheet-visible'); },
            closeAllSheets() { document.getElementById('backdrop').classList.replace('backdrop-visible', 'backdrop-hidden'); document.querySelectorAll('[id^="sheet-"]').forEach(el => el.classList.replace('sheet-visible', 'sheet-hidden')); setTimeout(()=>this.resetUpload(), 300); },
            resetUpload() { document.querySelector('form').reset(); this.tempFile = null; document.getElementById('upload-text').textContent = "Tap to select PDF"; },
            handleFileSelect(input) { if (input.files[0]) { this.tempFile = input.files[0]; document.getElementById('upload-text').textContent = this.tempFile.name; const m = this.tempFile.name.match(/(19|20)\d{2}/); if(m && !document.getElementById('inp-year').value) document.getElementById('inp-year').value = m[0]; } },
            saveMeta() { localStorage.setItem('AntigravityMeta_v5', JSON.stringify(this.data)); }
        };
        window.onload = () => app.init();
    </script>
</body>
</html>